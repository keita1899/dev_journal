---
description: Railsのモデル、コントローラー、サービスオブジェクト、パフォーマンス、エラーハンドリング、セキュリティに関するルール
globs: **/*.rb
alwaysApply: true
---

## モデル

- バリデーションは明確に記述
- `enum` を使用する場合は値も明示
- コールバックは必要最小限に
- スコープは必要に応じて定義（例: `Article.published`）

## コントローラー

- コントローラーは「HTTP リクエストの受付」「データの取得」「レスポンスの返却」のみに集中する
- ビジネスロジック、複雑な分岐、データの加工はコントローラーに書かず、モデルまたは Form Object に移譲する
- コントローラーのアクションメソッドは可能な限り短く保つ
- `before_action` で認証チェックを行う
- 早期リターンを使用してネストを浅くする
- エラーハンドリングは適切に行う（例: `destroy` は `destroy!` ではなく `destroy` を使用）
- リダイレクト時のステータスコードを適切に設定（例: `destroy` は `:see_other`）
- 権限チェックは `current_user.articles.find` のようにスコープを使用

## サービスオブジェクト

- 安易な Service Object（例: CreateUserService）の作成を避ける
- Service Object は「外部 API 連携」や「メール送信を含む複雑な副作用」など、純粋なドメインロジック以外が必要な場合にのみ検討する

## パフォーマンス

- N+1 問題を避けるため `includes` を使用
- ページネーションは Kaminari を使用
- 不要なクエリを避ける

## エラーハンドリング

- バリデーションエラーは適切に表示
- 404 エラーは `ActiveRecord::RecordNotFound` を raise

## セキュリティ

- 常に権限チェックを行う（`current_user.articles.find` など）
- パラメータは `strong_parameters` で適切にフィルタリング
- 認証が必要なアクションは `before_action :authenticate_user!` で保護
- 他人のリソースへのアクセスは 404 エラーを返す
- 生の SQL を使用しない
